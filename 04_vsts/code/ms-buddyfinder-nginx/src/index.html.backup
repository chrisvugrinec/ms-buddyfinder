<!DOCTYPE html>
<html>
  <head>
    <title>ms buddytracker</title>
    <script src="./scripts/jquery-1.10.2.min.js"></script>
  </head>
  <style type="text/css">
    body {
     background-image: url(images/ms-officemap.png);
     background-repeat: no-repeat;
    }
  </style>

<body>

  <div class="csacolony"></div>

  <map name="buddymap">
    <area shape="rect" coords="630,60,1000,350" href="csacolony.html" alt="csacolony">
    <area shape="rect" coords="630,420,1000,750" href="beantime.html" alt="beantime">
    <area shape="rect" coords="30,600,600,750" href="lunch.html" alt="lunch">
  </map>
<script>

$.ajaxSetup ({
    cache: false
});

function removeUser(uuid) {

        $.ajax({
             type: "GET",
             url: "https://datalinks.nl:3000/out?id="+uuid,
             error: function(data){
               console.log("exception removing user "+uuid+"from cache");
             }
         });
}

(function poll() {
    setTimeout(function() {
        $.ajax({
            url: "https://datalinks.nl:3000/status",
            type: "GET",
            success: function(data) {
                $.each( data, function( key, val ) {
                   console.log(val.beacon);
                   if (document.getElementById(val.uuid) == null){
                     $( "<div id="+val.uuid+" style='background: url("+val.logo+"); font-family:Arial, Helvetica,sans-serif; color:#4256f4;font-weight: bold;  background-size: 60px 60px; height: 60px; width: 60px; background-repeat: no-repeat;'>"+val.name+"</div>" ).appendTo( "div.csacolony" ).offset({ left: val.top, top: val.left});
                      $("#"+val.uuid+"").attr("beacon", val.beacon);

                   }else{
                     console.log("user "+val.name+" already on screen action  is "+val.state);
                     console.log("location on existing div: "+$("#"+val.uuid+"").attr("beacon"));
                     console.log("location from backend: "+val.beacon);
                     // if already exists but beacon has changed...remove and create again
                     if ($("#"+val.uuid+"").attr("beacon") != val.beacon   ){
                        console.log("changed location");
                        document.getElementById(val.uuid).remove();
                        $( "<div id="+val.uuid+" style='background: url("+val.logo+"); font-family:Arial, Helvetica,sans-serif; color:#4256f4;font-weight: bold;  background-size: 60px 60px; height: 60px; width: 60px; background-repeat: no-repeat;'>"+val.name+"</div>" ).appendTo( "div.csacolony" ).offset({ left: val.top, top: val.left});
                        $("#"+val.uuid+"").attr("beacon", val.beacon);


                     }
                     // not in means it should be of the screen and removed from redis cache
                     if(!(val.state.indexOf("in_")>-1)){
                        document.getElementById(val.uuid).remove();
                        removeUser(val.uuid);
                     }
                   }
                });
            },
            dataType: "json",
            complete: poll,
            timeout: 4000
        })
    }, 5000);
})();


</script>
</body>                                        
</html>
